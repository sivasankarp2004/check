<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leave Request Form</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .form-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            padding: 20px;
            width: 400px;
            transition: transform 0.5s ease-in-out;
        }
        
        h2 {
            text-align: center;
            color: #333;
            font-size: 24px;
        }
        .input-box {
            position: relative;
            margin: 20px 0;
        }
        .input-box input, .input-box select, .input-box textarea {
            width: 95%;
            padding: 10px;
            background: #f9f9f9;
            border: none;
            outline: none;
            font-size: 16px;
            border-radius: 5px;
            transition: background 0.3s ease-in-out;
        }
        .input-box input:focus, .input-box select:focus, .input-box textarea:focus {
            background: #e9e9e9;
        }
        .input-box label {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #aaa;
            font-size: 14px;
            pointer-events: none;
            transition: all 0.3s ease-in-out;
        }
        .input-box input:focus + label,
        .input-box input:valid + label,
        .input-box select:focus + label,
        .input-box select:valid + label,
        .input-box textarea:focus + label,
        .input-box textarea:valid + label {
            top: -20px;
            left: 10px;
            color: #333;
            font-size: 12px;
        }
        .btn {
            width: 100%;
            padding: 10px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s ease-in-out;
        }
        .btn:hover {
            background: #45a049;
        }
        .profile-photo {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            overflow: hidden;
        }
        .profile-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        input[type="file"] {
            display: none;
        }
        .upload-btn {
            display: block;
            margin: 10px auto;
            padding: 8px 16px;
            background-color: #49ffdb;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        /* Mobile Styles */
        @media (max-width: 600px) {
            .form-container {
                width: 90%;
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="form-container" id="yellow"style="display:none;">
        <div style='text-align: center;'>
            <h2 style='color: white; background: linear-gradient(to right, yellow, orange); padding: 12px 25px; border: 2px solid black; border-radius: 10px; font-size: 20px; display: inline-block; box-shadow: 2px 4px 6px rgba(0, 0, 0, 0.3); text-transform: uppercase; cursor: pointer; transition: transform 0.3s ease, background 0.3s ease, box-shadow 0.3s ease, letter-spacing 0.3s ease;'
            onmouseover="this.style.transform='scale(1.1)'; this.style.background='linear-gradient(to right, orange, red)'; this.style.boxShadow='4px 6px 10px rgba(0, 0, 0, 0.5)'; this.style.letterSpacing='2px';"
            onmouseout="this.style.transform='scale(1)'; this.style.background='linear-gradient(to right, yellow, orange)'; this.style.boxShadow='2px 4px 6px rgba(0, 0, 0, 0.3)'; this.style.letterSpacing='0';">YELLOW PASS REQUESTS</h2>
        </div>
        
        <form id="leaveForm">
            <div class="profile-photo" id="profilePhoto">
                <img id="photoPreview" src="https://cdn-icons-png.flaticon.com/512/9203/9203764.png" alt="Profile Photo">
            </div>
            <input type="file" id="photoInput">
            
            <!-- Name -->
            <div class="input-box">
                <h5>Name</h5>
                <input type="text" id="name" required readonly>
                <label for="name"></label>
            </div>
            <!-- Register No -->
            <div class="input-box">
                <h5>Register Number</h5>
                <input type="text" id="regNo" required readonly>
                <label for="regNo"></label>
            </div>
            
            <div class="input-box">
                <h5>Gender</h5>
                <input type="text" id="gender" required readonly>
                    <label for="gender"></label>
            </div>

            <!-- Class -->
            <div class="input-box">
                <h5>Year</h5>
                <input type="text" id="year" required readonly>
                <label for="year"></label>
            </div>

            <div class="input-box">
                <h5>Department</h5>
                <input type="text" id="department" required readonly>
                <label for="department"></label>
            </div>
            <!-- Room No -->
            <div class="input-box">
                <h5>Room Number</h5>
                <input type="text" id="roomNo" required readonly>
                <label for="roomNo"></label>
            </div>
            
            <!-- Phone Number -->
            <div class="input-box">
                <h5>Mobile Number</h5>
                <input type="tel" id="phone" required readonly>
                <label for="phone"></label>
            </div>
            <!-- Contact Address -->
            <div class="input-box">
                <h5>Parents Mobile Number</h5>
                <textarea id="parentsno" rows="1" required readonly></textarea>
                <label for="parentsno"></label>
            </div>
            <!-- Destination -->
            <div class="input-box">
                <h5>Destination (Place)</h5>
                <input type="text" id="destination" required readonly>
                <label for="destination"></label>
            </div>
            <!-- Reason for Leave -->
            <div class="input-box">
                <textarea id="reason" rows="3" required></textarea>
                <label for="reason">Reason for Leave</label>
            </div>
            <!-- Period From (Date) -->
            <div class="input-box">
                <h5>Period From (Date)</h5>
                <input type="date" id="fromDate" required readonly onchange="calculateDays();">
                <label for="fromDate"></label>
            </div>
            <!-- Period To (Date) -->
            <div class="input-box">
                <h5>Period To (Date)</h5>
                <input type="date" id="toDate" required onchange="calculateDays();">
                <label for="toDate"></label>
            </div>
            <!-- How many days -->
            <div class="input-box">
                <h5>How Many Days</h5>
                <input type="number" id="days" required readonly>
                <label for="days"></label>
            </div>
            <!-- Return to College (Date and Time) -->
            <div class="input-box">
                <h5>Return to College (Date and Time)</h5>
                <input type="datetime-local" id="returnDateTime" required>
                <label for="returnDateTime"></label>
            </div>
            <!-- Date -->
            <div class="input-box">
                <h5>Current Time</h5>
                <input type="datetime-local" id="date" required readonly>
                <label for="date"></label>
            </div>
            <!-- Gender Selection -->
            

            <button type="submit" class="btn" onclick="register()">Submit</button>
        </form>
    </div>
    <script>
        // Set default date input value to current date and disable calendar

       

        function formatDateTo12Hour(dateTime) {
  // Convert to Date object
  let date = new Date(dateTime);

  // Extract date components
  let year = date.getFullYear();
  let month = ('0' + (date.getMonth() + 1)).slice(-2);
  let day = ('0' + date.getDate()).slice(-2);

  // Extract time components
  let hours = date.getHours();
  let minutes = ('0' + date.getMinutes()).slice(-2);
  let ampm = hours >= 12 ? 'PM' : 'AM';
  hours = hours % 12 || 12; // Convert to 12-hour format

  // Format the date and time as desired
  return `${year}-${month}-${day} ${hours}:${minutes} ${ampm}`;
}










        const token=localStorage.getItem("token")
        loadProfileDetails()
        function setDefaultFromDate() {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');

        const formattedDate = `${year}-${month}-${day}`;
        document.getElementById('fromDate').value = formattedDate;
    }

    // Set default for "Period From" when the page loads
    window.onload = function() {
        setDefaultFromDate(); // Call the function to set the default date for Period From
        setDefaultDate(); // Call the function to set the default date and time for Current Time
    };
    window.onload = function() {
    // Set default current date for "Period From (Date)" input
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    
    const formattedDate = `${year}-${month}-${day}`;
    const formattedDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;

    // Set default for "Period From (Date)"
    document.getElementById('fromDate').value = formattedDate;

    // Set default for "Current Time" field
    document.getElementById('date').value = formattedDateTime;
};


        // Function to handle profile photo upload
        const photoInput = document.getElementById('photoInput');
        const photoPreview = document.getElementById('photoPreview');

        photoInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    photoPreview.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // Function to calculate the number of days between two dates
        function calculateDays() {
            const fromDate = new Date(document.getElementById('fromDate').value);
            const toDate = new Date(document.getElementById('toDate').value);

            if (fromDate && toDate && fromDate <= toDate) {
                const differenceInTime = toDate - fromDate;
                const differenceInDays = differenceInTime / (1000 * 3600 * 24);
                document.getElementById('days').value = differenceInDays;
            } else {
                document.getElementById('days').value = 0; // Reset if invalid
            }
        }

        // Upload photo function
        async function uploadPhoto(file) {
            const formData = new FormData();
            formData.append('photo', file);

            const response = await fetch('http://localhost:5000/api/upload-photo', {
                method: 'POST',
                body: formData,
            });

            if (!response.ok) {
                throw new Error('Failed to upload photo');
            }

            const data = await response.json();
            return data.url; // Assuming your server returns the photo URL
        }

        // Form submission
        document.getElementById('leaveForm').addEventListener('submit', async (event) => {
            event.preventDefault(); // Prevent default form submission

            const file = photoInput.files[0];
            let photoUrl;

            if (file) {
                try {
                    photoUrl = await uploadPhoto(file);
                } catch (error) {
                    console.error(error);
                    alert('Photo upload failed!');
                    return;
                }
            }

            // Gather form data
            const leaveRequestData = {
                date:document.getElementById('date').value,
                name: document.getElementById('name').value,
                regNo: document.getElementById('regNo').value,
                gender: document.getElementById('gender').value,
                year: document.getElementById('year').value,
                department: document.getElementById('department').value,
                roomNo: document.getElementById('roomNo').value,
                reason: document.getElementById('reason').value,
                fromDate: document.getElementById('fromDate').value,
                toDate: document.getElementById('toDate').value,
                days: document.getElementById('days').value,
            
              
                phone: document.getElementById('phone').value,
                returnDateTime: document.getElementById('returnDateTime').value,
          
            };

            // Submit leave request data
            const response = await fetch('http://localhost:5000/api/leave-request', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(leaveRequestData),
            });

            if (response) {
                alert('Leave request submitted successfully!');
                document.getElementById('leaveForm').reset();
                photoPreview.src = 'https://cdn-icons-png.flaticon.com/512/9203/9203764.png'; // Reset photo preview
            } else {
                alert('Error submitting leave request!');
            }
        });

        // Initialize default date values
        // setDefaultDate();






        async function loadProfileDetails() {
            const token = localStorage.getItem("token");
    
            try {
                const response = await fetch("http://localhost:5000/student", {
                    method: "GET",
                    headers: {
                        Authorization: `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();
                 if(data.Ypass==1){
                 alert("Already applied")
                   window.location.href='./Login_Page.html'
                 }
    
                // Populate the form with profile details
                document.getElementById('name').value = data.name;


                document.getElementById('regNo').value = data.regNo;
                document.getElementById('year').value = data.courseYear;
                document.getElementById('gender').value = data.gender;
                document.getElementById('roomNo').value = data.roomNo;
                document.getElementById('department').value = data.course;
                document.getElementById('parentsno').value = data.parentsno;
                document.getElementById('phone').value = data.studentPhone;
                document.getElementById('destination').value = data.nativePlace;
                // Set the profile image
                const profileImageUrl = data.photo;  // Assuming the URL is returned by the API
                document.getElementById('photoPreview').src = profileImageUrl;
    
            } catch (err) {
                console.log(err);
            }
        }
    

       






        async function register(){
            const reason = document.getElementById("reason").value;

const fromDate = document.getElementById("fromDate").value;

const toDate = document.getElementById("toDate").value;
console.log(toDate)

const days = document.getElementById("days").value;

const returnDateTime = document.getElementById("returnDateTime").value;

const currentTime = document.getElementById("date").value;
            try {
                const response = await fetch('http://localhost:5000/addPass', {
                    method: 'POST',
                    headers: {
                        Authorization:`Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
        reason,
        fromDate,
        toDate,
        days,
        currentTime:formatDateTo12Hour(document.getElementById('date').value) }),
                });

                const data = await response.json();
            }
            catch(err){
                console.log(err)
            }

        }

        async function getStudent() {
            try {
                const response = await fetch('http://localhost:5000/yp', {
                    method: 'GET',
                    headers: {
                        Authorization:`Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                });
                const data=await response.json()
                console.log(data)
                if(data.response.status=="on"){
                    document.getElementById("yellow").style.display="block"
                   return;
                }
                else{
                    window.location.href="./Login_Page.html"
                }
            }
            catch(err){
                console.log(err)
                
            }
        }
        getStudent()



    </script>
</body>
</html>
