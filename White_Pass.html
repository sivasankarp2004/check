<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leave Request Form</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .form-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            padding: 20px;
            width: 400px;
            transition: transform 0.5s ease-in-out;
        }
        
        h2 {
            text-align: center;
            color: #333;
            font-size: 24px;
        }
        .input-box {
            position: relative;
            margin: 20px 0;
        }
        .input-box input, .input-box select, .input-box textarea {
            width: 95%;
            padding: 10px;
            background: #f9f9f9;
            border: none;
            outline: none;
            font-size: 16px;
            border-radius: 5px;
            transition: background 0.3s ease-in-out;
        }
        .input-box input:focus, .input-box select:focus, .input-box textarea:focus {
            background: #e9e9e9;
        }
        .input-box label {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #aaa;
            font-size: 14px;
            pointer-events: none;
            transition: all 0.3s ease-in-out;
        }
        .input-box input:focus + label,
        .input-box input:valid + label,
        .input-box select:focus + label,
        .input-box select:valid + label,
        .input-box textarea:focus + label,
        .input-box textarea:valid + label {
            top: -20px;
            left: 10px;
            color: #333;
            font-size: 12px;
        }
        .btn {
            width: 100%;
            padding: 10px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s ease-in-out;
        }
        .btn:hover {
            background: #45a049;
        }
        .profile-photo {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            overflow: hidden;
        }
        .profile-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        input[type="file"] {
            display: none;
        }
        .upload-btn {
            display: block;
            margin: 10px auto;
            padding: 8px 16px;
            background-color: #49ffdb;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        /* Mobile Styles */
        @media (max-width: 600px) {
            .form-container {
                width: 90%;
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="form-container" id="white" style="display: none;">
        <div style='text-align: center;'>
            <h2 style='color: black; background: linear-gradient(to right, white, lightgray); padding: 12px 25px; border: 2px solid black; border-radius: 10px; font-size: 20px; display: inline-block; box-shadow: 2px 4px 6px rgba(0, 0, 0, 0.3); text-transform: uppercase; cursor: pointer; transition: transform 0.3s ease, background 0.3s ease, box-shadow 0.3s ease, letter-spacing 0.3s ease;'
            onmouseover="this.style.transform='scale(1.1)'; this.style.background='linear-gradient(to right, lightgray, darkgray)'; this.style.boxShadow='4px 6px 10px rgba(0, 0, 0, 0.5)'; this.style.letterSpacing='2px';"
            onmouseout="this.style.transform='scale(1)'; this.style.background='linear-gradient(to right, white, lightgray)'; this.style.boxShadow='2px 4px 6px rgba(0, 0, 0, 0.3)'; this.style.letterSpacing='0';">WHITE PASS REQUESTS</h2>
        </div>
        
        
        
        <form id="leaveForm">
            <div class="profile-photo" id="profilePhoto">
                <img id="photoPreview" src="https://cdn-icons-png.flaticon.com/512/9203/9203764.png" alt="Profile Photo">
            </div>
            <input type="file" id="photoInput" >


            
            <!-- Name -->
            <div class="input-box">
                <h5>Name</h5>
                <input type="text" id="name" required readonly>
                <label for="name"></label>
            </div>
            <!-- Register No -->
            <div class="input-box">
                <h5>Register Number</h5>
                <input type="text" id="regNo" required readonly>
                <label for="regNo"></label>
            </div>
            <div class="input-box">
                <h5>Gender</h5>
                <input type="text" id="gender" required readonly>
                    <label for="gender"></label>
            </div>
            <!-- Class -->
            <div class="input-box">
                <h5>Year</h5>
                <input type="text" id="year" required readonly>
                <label for="year"></label>
            </div>

            <div class="input-box">
                <h5>Department</h5>
                <input type="text" id="department" required readonly>
                <label for="department"></label>
            </div>
            <!-- Room No -->
            <div class="input-box">
                <h5>Room Number</h5>
                <input type="text" id="roomNo" required readonly>
                <label for="roomNo"></label>
            </div>

             
            <!-- Phone Number -->
            <div class="input-box">
                <h5>Mobile Number</h5>
                <input type="tel" id="phone" required readonly pattern="[0-9]{10}">
                <label for="phone"></label>
            </div>
            <!-- Contact Address -->
            <div class="input-box">
                <h5>Parents Mobile Number</h5>
                <textarea id="parentsno" rows="1" required readonly></textarea>
                <label for="parentsno"></label>
            </div>

            <!-- Reason for Leave -->
            <div class="input-box">
             
                <textarea id="reason" rows="3" required></textarea>
                <label for="reason">Reason</label>
            </div>
            <!-- Period From (Date) -->
            <div class="input-box">
                <h5>Period From (Time-In)</h5>
                <input type="time" id="fromDate" required onchange="calculateDays();">
                <label for="fromDate"></label>
            </div>
            <!-- Period To (Date) -->
            <div class="input-box">
                <h5>Period To (Time-Out)</h5>
                <input type="time" id="toDate" required onchange="calculateDays();">
                <label for="toDate"></label>
            </div>
            <!-- How many days -->
            <div class="input-box">
                <h5>(How many Hours)</h5>
                <input type="number" id="days" required readonly>
                <label for="days"></label>
            </div>

           
            <!-- Date -->
            <div class="input-box">
                <h5>Current Time</h5>
                <input type="datetime-local" id="date" required readonly>
                <label for="date"></label>
            </div>


            <!-- Submit Button -->
            <button type="submit" class="btn">Submit</button>
        </form>
    </div>

    <script>
        // Set default date input value to current date and disable calendar




        function formatDateTo12Hour(dateTime) {
  // Convert to Date object
  let date = new Date(dateTime);

  // Extract date components
  let year = date.getFullYear();
  let month = ('0' + (date.getMonth() + 1)).slice(-2);
  let day = ('0' + date.getDate()).slice(-2);

  // Extract time components
  let hours = date.getHours();
  let minutes = ('0' + date.getMinutes()).slice(-2);
  let ampm = hours >= 12 ? 'PM' : 'AM';
  hours = hours % 12 || 12; // Convert to 12-hour format

  // Format the date and time as desired
  return `${year}-${month}-${day} ${hours}:${minutes} ${ampm}`;
}










        const token=localStorage.getItem("token")
        loadProfileDetails()
        function setDefaultDate() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');

            const formattedDate = `${year}-${month}-${day}T${hours}:${minutes}`;
            document.getElementById('date').value = formattedDate;
        }

        // Function to handle profile photo upload
        const photoInput = document.getElementById('photoInput');
        const photoPreview = document.getElementById('photoPreview');

        photoInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    photoPreview.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // Function to calculate the number of days between two dates
        function calculateDays() {
            const fromDate = new Date(document.getElementById('fromDate').value);
            const toDate = new Date(document.getElementById('toDate').value);

            if (fromDate && toDate && fromDate <= toDate) {
                const differenceInTime = toDate - fromDate;
                const differenceInDays = differenceInTime / (1000 * 3600 * 24);
                document.getElementById('days').value = differenceInDays;
            } else {
                document.getElementById('days').value = 0; // Reset if invalid
            }
        }

        // Upload photo function
        async function uploadPhoto(file) {
            const formData = new FormData();
            formData.append('photo', file);

            const response = await fetch('http://localhost:5000/api/upload-photo', {
                method: 'POST',
                body: formData,
            });

            if (!response.ok) {
                throw new Error('Failed to upload photo');
            }

            const data = await response.json();
            return data.url; // Assuming your server returns the photo URL
        }

        // Form submission
        document.getElementById('leaveForm').addEventListener('submit', async (event) => {
            event.preventDefault(); // Prevent default form submission

            const file = photoInput.files[0];
            let photoUrl;

            if (file) {
                try {
                    photoUrl = await uploadPhoto(file);
                } catch (error) {
                    console.error(error);
                    alert('Photo upload failed!');
                    return;
                }
            }


            

            function convertTo12HourFormat(time) {
  // Split the time into hours and minutes
  let [hours, minutes] = time.split(':');
  
  // Convert hours from string to number
  hours = parseInt(hours);

  // Determine AM or PM
  const ampm = hours >= 12 ? 'PM' : 'AM';

  // Convert hours to 12-hour format
  hours = hours % 12 || 12; // 0 is converted to 12

  // Return the formatted time
  return `${hours}:${minutes} ${ampm}`;
}



            const leaveRequestData = {

              




                date:document.getElementById('date').value,
                name: document.getElementById('name').value,
                regNo: document.getElementById('regNo').value,
                gender: document.getElementById('gender').value,
                year: document.getElementById('year').value,
                department: document.getElementById('department').value,
                roomNo: document.getElementById('roomNo').value,
                reason: document.getElementById('reason').value,
                fromTime:convertTo12HourFormat(document.getElementById('fromDate').value),
                toTime: convertTo12HourFormat(document.getElementById('toDate').value),
                Hours: document.getElementById('days').value,
                phone: document.getElementById('phone').value,
                currentTime:formatDateTo12Hour(document.getElementById('date').value)

            };

            // Submit leave request data
            const response = await fetch('http://localhost:5000/addWPass', {
                method: 'POST',
                headers: {
                    Authorization:`Bearer ${token}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(leaveRequestData),
            });

            if (response.ok) {
                alert('Leave request submitted successfully!');
                document.getElementById('leaveForm').reset();
                photoPreview.src = 'https://cdn-icons-png.flaticon.com/512/9203/9203764.png'; // Reset photo preview
            } else {
                alert('Error submitting leave request!');
            }
        });

        // Initialize default date values
        setDefaultDate();






        async function loadProfileDetails() {
            const token = localStorage.getItem("token");
    
            try {
                const response = await fetch("http://localhost:5000/student", {
                    method: "GET",
                    headers: {
                        Authorization: `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();
    
                // Populate the form with profile details
                document.getElementById('name').value = data.name;
                document.getElementById('regNo').value = data.regNo;
                document.getElementById('year').value = data.courseYear;
                document.getElementById('gender').value = data.gender;
                document.getElementById('roomNo').value = data.roomNo;
                document.getElementById('department').value = data.course;
                document.getElementById('parentsno').value = data.parentsno;
                document.getElementById('phone').value = data.studentPhone;
                // Set the profile image
                const profileImageUrl = data.photo;  // Assuming the URL is returned by the API
                document.getElementById('photoPreview').src = profileImageUrl;
    
            } catch (err) {
                console.log(err);
            }
        }
    

function calculateHours() {
        const fromTime = document.getElementById('fromDate').value;
        const toTime = document.getElementById('toDate').value;

        if (fromTime && toTime) {
            const [fromHours, fromMinutes] = fromTime.split(':').map(Number);
            const [toHours, toMinutes] = toTime.split(':').map(Number);

            // Create date objects for calculations
            const fromDate = new Date();
            fromDate.setHours(fromHours, fromMinutes, 0);

            const toDate = new Date();
            toDate.setHours(toHours, toMinutes, 0);

            // If the end time is before the start time, it means it goes past midnight
            if (toDate < fromDate) {
                toDate.setDate(toDate.getDate() + 1); // Add one day to the end time
            }

            const differenceInTime = toDate - fromDate; // Difference in milliseconds
            const differenceInHours = differenceInTime / (1000 * 3600); // Convert milliseconds to hours
            document.getElementById('days').value = differenceInHours.toFixed(2); // Display hours with two decimal places
        } else {
            document.getElementById('days').value = 0; // Reset if any input is empty
        }
    }



    async function getStudent() {
            try {
                const response = await fetch('http://localhost:5000/wp', {
                    method: 'GET',
                    headers: {
                        Authorization:`Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                });
                const data=await response.json()
                console.log(data)
                if(data.response.status=="on"){
                    document.getElementById("white").style.display="block"
                   return;
                }
                else{
                    window.location.href="./Login_Page.html"
                }
            }
            catch(err){
                console.log(err)
                
            }
        }
        getStudent()












    // Update the onchange event to use the new function
    document.getElementById('fromDate').addEventListener('change', calculateHours);
    document.getElementById('toDate').addEventListener('change', calculateHours);







    </script>
</body>
</html>
